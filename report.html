<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–û—Ç—á–µ—Ç –ø–æ –ø—Ä–∞–≤–∫–∞–º</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      padding: 20px;
      background: #f4f5f7;
      margin: 0;
    }
    h2 {
      color: #172b4d;
      margin-bottom: 20px;
    }
    .filters {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .filter-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 10px;
      align-items: end;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    .filter-group label {
      font-size: 12px;
      color: #5e6c84;
      margin-bottom: 5px;
      font-weight: 600;
    }
    input[type="date"], select {
      padding: 8px;
      border: 1px solid #dfe1e6;
      border-radius: 3px;
      font-size: 14px;
      color: #172b4d;
      background: white;
    }
    #report {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
      color: #172b4d;
    }
    th {
      background: #0079bf;
      color: white;
      font-weight: 600;
    }
    tr:hover {
      background: #f9f9f9;
    }
    tr {
      cursor: pointer;
    }
    .card-name {
      color: #172b4d;
      font-weight: 500;
    }
    .card-name:hover {
      color: #0079bf;
      text-decoration: underline;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin: 5px 0;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    button {
      background: #0079bf;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #026aa7;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .group-header {
      background: #f4f5f7;
      font-weight: bold;
      color: #172b4d;
    }
    .group-header td {
      padding: 15px 12px;
      font-size: 15px;
    }
    .member-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      vertical-align: middle;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <h2>üìä –û—Ç—á–µ—Ç –ø–æ –ø—Ä–∞–≤–∫–∞–º</h2>
  
  <div class="filters">
    <div class="filter-row">
      <div class="filter-group">
        <label>–î–∞—Ç–∞ —Å:</label>
        <input type="date" id="dateFrom">
      </div>
      <div class="filter-group">
        <label>–î–∞—Ç–∞ –ø–æ:</label>
        <input type="date" id="dateTo">
      </div>
      <div class="filter-group">
        <label>–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:</label>
        <select id="groupBy">
          <option value="none">–ë–µ–∑ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏</option>
          <option value="member">–ü–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é</option>
        </select>
      </div>
      <button onclick="generateReport()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </div>

  <div id="report">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
  </div>

  <script>
    const t = window.TrelloPowerUp.iframe();

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)
    window.onload = function() {
      const today = new Date();
      const monthAgo = new Date();
      monthAgo.setDate(today.getDate() - 30);
      
      document.getElementById('dateTo').valueAsDate = today;
      document.getElementById('dateFrom').valueAsDate = monthAgo;
      
      generateReport();
    };

    async function generateReport() {
      const reportDiv = document.getElementById('report');
      reportDiv.innerHTML = '<div class="loading">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...</div>';

      try {
        // –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        const dateFrom = document.getElementById('dateFrom').value ? new Date(document.getElementById('dateFrom').value) : null;
        const dateTo = document.getElementById('dateTo').value ? new Date(document.getElementById('dateTo').value + 'T23:59:59') : null;
        const groupBy = document.getElementById('groupBy').value;

        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏
        const allCards = await t.cards('all');
        
        // –ü–æ–ª—É—á–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è –¥–æ—Å–∫–∏
        const board = await t.board('all');
        const customFields = board.customFields || [];
        
        // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–µ "–ü—Ä–∞–≤–∫–∏"
        const pravkiField = customFields.find(field => 
          field.name.toLowerCase().includes('–ø—Ä–∞–≤–∫–∏') ||
          field.name.toLowerCase().includes('pravki')
        );

        if (!pravkiField) {
          reportDiv.innerHTML = `
            <p style="color: red;">‚ùå –ö–∞—Å—Ç–æ–º–Ω–æ–µ –ø–æ–ª–µ "–ü—Ä–∞–≤–∫–∏" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∞ –¥–æ—Å–∫–µ</p>
            <p style="color: #666; font-size: 14px;">–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞ –¥–æ—Å–∫–µ –µ—Å—Ç—å –∫–∞—Å—Ç–æ–º–Ω–æ–µ –ø–æ–ª–µ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º "–ü—Ä–∞–≤–∫–∏"</p>
          `;
          return;
        }

        // –ü–æ–ª—É—á–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–æ—Å–∫–∏
        const boardData = await t.board('members');
        const membersMap = {};
        if (boardData.members) {
          boardData.members.forEach(member => {
            membersMap[member.id] = member;
          });
        }

        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const reportData = [];
        let totalPravki = 0;

        for (const card of allCards) {
          // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è
          const cardDate = new Date(card.dateLastActivity);
          if (dateFrom && cardDate < dateFrom) continue;
          if (dateTo && cardDate > dateTo) continue;

          const customFieldItem = card.customFieldItems?.find(
            item => item.idCustomField === pravkiField.id
          );

          if (customFieldItem) {
            let pravkiValue = 0;
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –ø–æ–ª–µ–π
            if (customFieldItem.value) {
              if (customFieldItem.value.number !== undefined) {
                pravkiValue = customFieldItem.value.number;
              } else if (customFieldItem.value.text !== undefined) {
                pravkiValue = Number(customFieldItem.value.text) || 0;
              }
            }

            if (pravkiValue > 0) {
              // –ü–æ–ª—É—á–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–∞—Ä—Ç–æ—á–∫–∏
              const cardMembers = card.idMembers || [];
              const memberNames = cardMembers.map(id => {
                const member = membersMap[id];
                return member ? member.fullName : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
              });
              
              reportData.push({
                name: card.name,
                pravki: pravkiValue,
                url: card.shortUrl || card.url,
                members: cardMembers,
                memberNames: memberNames
              });
              totalPravki += pravkiValue;
            }
          }
        }

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –ø—Ä–∞–≤–æ–∫
        reportData.sort((a, b) => b.pravki - a.pravki);

        // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –æ—Ç—á–µ—Ç
        const avgPravki = reportData.length > 0 ? (totalPravki / reportData.length).toFixed(2) : 0;
        
        let html = `
          <div class="stats">
            <div class="stat-card">
              <div class="stat-label">–í—Å–µ–≥–æ –ø—Ä–∞–≤–æ–∫</div>
              <div class="stat-value">${totalPravki}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">–ö–∞—Ä—Ç–æ—á–µ–∫ —Å –ø—Ä–∞–≤–∫–∞–º–∏</div>
              <div class="stat-value">${reportData.length}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ</div>
              <div class="stat-value">${avgPravki}</div>
            </div>
          </div>
        `;

        if (reportData.length > 0) {
          if (groupBy === 'member') {
            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é
            const grouped = {};
            
            reportData.forEach(item => {
              if (item.members.length === 0) {
                if (!grouped['–ë–µ–∑ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è']) grouped['–ë–µ–∑ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è'] = [];
                grouped['–ë–µ–∑ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è'].push(item);
              } else {
                item.members.forEach((memberId) => {
                  const member = membersMap[memberId];
                  const memberName = member ? member.fullName : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                  if (!grouped[memberName]) grouped[memberName] = [];
                  grouped[memberName].push(item);
                });
              }
            });

            html += '<table><thead><tr><th>–ö–∞—Ä—Ç–æ—á–∫–∞</th><th>–ü—Ä–∞–≤–æ–∫</th></tr></thead><tbody>';
            
            Object.keys(grouped).sort().forEach(memberName => {
              const items = grouped[memberName];
              const memberTotal = items.reduce((sum, item) => sum + item.pravki, 0);
              
              html += `
                <tr class="group-header">
                  <td colspan="2">
                    ${memberName} (${items.length} –∫–∞—Ä—Ç–æ—á–µ–∫, ${memberTotal} –ø—Ä–∞–≤–æ–∫)
                  </td>
                </tr>
              `;
              
              items.forEach(item => {
                html += `
                  <tr onclick="window.open('${item.url}', '_blank')">
                    <td class="card-name">${item.name}</td>
                    <td><span style="background: #ff6b6b; color: white; padding: 4px 10px; border-radius: 12px; font-weight: bold;">${item.pravki}</span></td>
                  </tr>
                `;
              });
            });
            
            html += '</tbody></table>';
            
          } else {
            // –ë–µ–∑ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
            html += `
              <table>
                <thead>
                  <tr>
                    <th>–ö–∞—Ä—Ç–æ—á–∫–∞</th>
                    <th>–ü—Ä–∞–≤–æ–∫</th>
                    <th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</th>
                  </tr>
                </thead>
                <tbody>
            `;

            reportData.forEach(item => {
              const membersList = item.memberNames.length > 0 
                ? item.memberNames.join(', ') 
                : '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ';
              
              html += `
                <tr onclick="window.open('${item.url}', '_blank')">
                  <td class="card-name">${item.name}</td>
                  <td><span style="background: #ff6b6b; color: white; padding: 4px 10px; border-radius: 12px; font-weight: bold;">${item.pravki}</span></td>
                  <td style="font-size: 13px; color: #5e6c84;">${membersList}</td>
                </tr>
              `;
            });

            html += '</tbody></table>';
          }
        } else {
          html += '<p style="text-align: center; padding: 40px; color: #999;">–ö–∞—Ä—Ç–æ—á–µ–∫ —Å –ø—Ä–∞–≤–∫–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ</p>';
        }

        reportDiv.innerHTML = html;

      } catch (error) {
        reportDiv.innerHTML = `
          <p style="color: red;">–û—à–∏–±–∫–∞: ${error.message}</p>
          <p style="color: #666; font-size: 14px;">–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (F12)</p>
        `;
        console.error('Error:', error);
      }
    }
  </script>
</body>
</html>
